services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 10s
      retries: 5

  logservice:
    build: .
    command: node dist/apps/log/logmain.js
    environment:
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - rabbitmq
    volumes:
      - ./log:/usr/src/app/log

  oms:
    build: .
    command: node dist/apps/oms/OmsMain.js
    environment:
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
      - PORT=3000
      - INVENTORY_URL=http://inventory:3001
      - PAYMENT_URL=http://payment:3002
    depends_on:
      - rabbitmq
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(3000,'localhost').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5

  inventory:
    build: .
    command: node dist/apps/inventory/src/InventoryMain.js
    environment:
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
      - PORT=3001
    depends_on:
      - rabbitmq
    ports:
      - "3005:3001"
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(3001,'localhost').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5

  payment:
    build: .
    command: node dist/apps/payment/Paymentmain.js
    environment:
      - SERVICE_NAME=payment
      - PORT=3002
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - rabbitmq
    ports:
      - "3002:3002"
    volumes:
      - ./log:/usr/src/app/log
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(3002,'localhost').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 5

  wms:
    build: .
    command: node dist/apps/wms/wmsmain.js
    environment:
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    depends_on:
      - rabbitmq

